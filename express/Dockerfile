FROM node:12.4.0-alpine as builder
RUN apk update && apk add git
WORKDIR /home
COPY package.json ./
COPY yarn.lock ./
ARG env=production
ENV NODE_ENV=${env}
RUN yarn install
COPY . .
ARG SITE_NAME=zipcube.com
ARG BUGSNAG_CLIENT_KEY
ARG FACEBOOK_APP_ID
ARG GOOGLE_CLIENT_ID
ARG LINKEDIN_APP_ID
ARG GOOGLE_MAP_API_KEY
ARG MAPBOX_API_KEY
ENV SITE_NAME=${SITE_NAME} BUGSNAG_CLIENT_KEY=${BUGSNAG_CLIENT_KEY} FACEBOOK_APP_ID=${FACEBOOK_APP_ID} GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID} LINKEDIN_APP_ID=${LINKEDIN_APP_ID} GOOGLE_MAP_API_KEY=${GOOGLE_MAP_API_KEY} MAPBOX_API_KEY=${MAPBOX_API_KEY}
RUN yarn build
RUN yarn babel

FROM node:12.4.0-alpine
WORKDIR /home
COPY --from=builder /home /home
ARG env=production
ARG SITE_NAME=zipcube.com
ARG BUGSNAG_CLIENT_KEY
ARG FACEBOOK_APP_ID
ARG GOOGLE_CLIENT_ID
ARG LINKEDIN_APP_ID
ARG GOOGLE_MAP_API_KEY
ARG MAPBOX_API_KEY
ENV NODE_ENV=${env} SITE_NAME=${SITE_NAME} BUGSNAG_CLIENT_KEY=${BUGSNAG_CLIENT_KEY} FACEBOOK_APP_ID=${FACEBOOK_APP_ID} GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID} LINKEDIN_APP_ID=${LINKEDIN_APP_ID} GOOGLE_MAP_API_KEY=${GOOGLE_MAP_API_KEY} MAPBOX_API_KEY=${MAPBOX_API_KEY}
CMD ["node", "server/index.js"]
